
<html>
 <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Scoring - Continental Divide</title>

<body>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" crossorigin="anonymous">
<style>
body{     padding: 5px 20px; }



.btn { color: #fff !important; }

.btn.pink { background-color: pink !important; color: #000 !important;}
.btn.red { background-color: red; }
.btn.blue { background-color: blue; }
.btn.black { background-color: black; }
.btn.yellow { background-color: yellow; color: #000 !important;}
.btn.brown { background-color: brown; }
.btn.purple { background-color: purple; }
.btn.green { background-color: green; }

.player input { width: 75px; }

input[type="number"] { width: 40px; }



.spinner {
  width: 100px;
}
.spinner input {
  text-align: right;
  width: 50% !important;
}
.input-group-btn-vertical {
  position: relative;
  white-space: nowrap;
  width: 1%;
  vertical-align: middle;
  display: table-cell;
  left: -40%;
}
.input-group-btn-vertical > .btn {
  display: block;
  float: none;
  width: 100%;
  max-width: 100%;
  padding: 8px;
  margin-left: -1px;
  position: relative;
  border-radius: 0;
}
.input-group-btn-vertical > .btn:first-child {
  border-top-right-radius: 4px;
}
.input-group-btn-vertical > .btn:last-child {
  margin-top: -2px;
  border-bottom-right-radius: 4px;
}
.input-group-btn-vertical i{
  position: absolute;
  top: 0;
  left: 4px;
}

.txt_val span {
  display: block;
  text-align: center;
}
</style>

<div class="row">

  <div class=".col-xs-12 .col-sm-6 .col-md-8 company_pane">
    <h2>Company</h2>
    <div class="company">
      <button class="btn blue ">Blue</button>
      <button class="btn red ">Red</button>
      <button class="btn yellow ">Yellow</button>
      <button class="btn pink ">Pink</button>
      <button class="btn green ">Green</button>      
      <button class="btn purple ">Purple</button>
      <button class="btn brown ">Brown</button>
      <button class="btn black ">Black</button>
    </div>

    <button type="button" class="btn btn-primary purchaseCompanyStock hidden" autocomplete="off"> 
      Purchase Stock 
    </button> 
  </div>
</div>

<div class="row company_pane__fields hidden">
  <div class="col-xs-12 col-md-12">
    <h3 class="company_name">Company</h3>
  </div>
</div>

<div class="row company_pane__fields hidden">
  <div class="col-xs-6 col-md-3"> 
    <div class="stock_value txt_val"> 
      <span>Stock Value</span> 
      <span id="stock_value__txt">0</span> 
    </div> 
  </div>
  <div class="col-xs-6 col-md-3"> 
    <div class="stocks_issued txt_val"> 
      <span>Stocks Issued</span> 
      <span id="stocks_issued__txt">0</span> 
    </div> 
  </div>
  <div class="col-xs-6 col-md-3"> 
    <div class="rr_income txt_val "> 
      <span>RR Income</span> 
      <span id="rr_income__txt">0</span>  
    </div> 
  </div>
  <div class="col-xs-6 col-md-3"> 
    <div class="rr_treasury  txt_val"> 
      <span>RR Treasury</span> 
      <span id="rr_treasury__txt">0</span> 
    </div> 
  </div>
</div>
<div class="row company_pane__fields hidden">
  <div class="col-xs-6 col-md-3"> 
    <div class="stock_price  txt_val"> 
      <span>Stock Price</span> 
      <span id="stock_price__txt">0</span> 
    </div> 
  </div>
  <div class="col-xs-6 col-md-3"> 
    <div class="dividend  txt_val"> 
      <span>Dividend</span> 
      <span id="dividend__txt">0</span> 
    </div> 
  </div>

  <div class="col-xs-6 col-md-3"> 
    <div class="remaining_stock  txt_val"> 
      <span>Stock Available</span> 
      <span id="remaining_stock__txt">0</span> 
    </div>
  </div>

  <div class="col-xs-6 col-md-3"> 
    <div class="dividend_payment  txt_val"> 
      <span>Div Pmt</span> 
      <span id="dividend_payment__txt">0</span> 
    </div>
  </div>
</div>
<div class="row">
  <div class=".col-xs-12 .col-sm-6 .col-md-8 log">
  </div>
</div>


<div class="modal fade" tabindex="-1" role="dialog" id="modal--username">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Enter your name</h4>
      </div>
      <div class="modal-body">
        Username: <input type="text" id="username">
        <br><br>
        <div class="dropdown">
          <a href="#" class="btn btn-primary dropdown-toggle" id="available_games_dd" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Game Instance <span class="caret"></span> </a>
<!--           <div class="panel panel-default">
            <div class="panel-body">
              
            </div>
          </div> -->
          <ul class="dropdown-menu available_games_dd" aria-labelledby="available_games_dd">            
          </ul>
        </div>
        <br><br>
        <div class="dropdown hidden">
          <a href="#" class="btn btn-primary dropdown-toggle" id="num_players" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Number of Players <span class="caret"></span> </a>
          <ul class="dropdown-menu num_players" aria-labelledby="num_players">     
            <li role="presentation" class="dropdown"><a href="#" id="num_players3" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" data-numplayers="3">3</a></li> 
            <li role="presentation" class="dropdown"><a href="#" id="num_players4" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" data-numplayers="4">4</a></li> 
            <li role="presentation" class="dropdown"><a href="#" id="num_players5" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" data-numplayers="5">5</a></li> 
            <li role="presentation" class="dropdown"><a href="#" id="num_players6" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" id=num_players6" data-numplayers="6">6</a></li>     
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary">Save</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" tabindex="-1" role="dialog" id="modal--buyStock">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Enter Number of Stocks and Price Paid</h4>
      </div>
      <div class="modal-body">
        <div class="row ">
          <div class="col-xs-6 col-md-4">
            <div class="stock_value "> 
              <span>Stock Value</span> 
              <span>
                <div class="input-group spinner"> 
                  <input type="text" class="form-control" value="0" data-action="stock_value"> 
                  <div class="input-group-btn-vertical"> 
                    <button class="btn btn-default" type="button" data-action="stock_value"><i class="fa fa-caret-up"></i></a> 
                    <button class="btn btn-default" type="button" data-action="stock_value"><i class="fa fa-caret-down"></i></a> 
                  </div> 
                </div>
              </span> 
            </div> 
          </div>
        </div>
        <div class="row ">
          <div class="col-xs-6 col-md-4">
            <div class="stocks_issued"> 
              <span># of Stocks Issued</span> 
              <span>
                <div class="input-group spinner"> 
                  <input type="text" class="form-control" value="0" data-action="stocks_issued"> 
                  <div class="input-group-btn-vertical"> 
                    <button class="btn btn-default" type="button" data-action="stocks_issued"><i class="fa fa-caret-up"></i></a> 
                    <button class="btn btn-default" type="button" data-action="stocks_issued"><i class="fa fa-caret-down"></i></a> 
                  </div> 
                </div>
              </span> 
            </div> 
          </div>
        </div>
        <div class="row ">
          <div class="col-xs-6 col-md-4">
            <div class="num_purchased_stocks"> 
              <span># Stocks to Purchase</span> 
              <span>
                <div class="input-group spinner"> 
                  <input type="text" class="form-control" value="1" > 
                  <div class="input-group-btn-vertical"> 
                    <button class="btn btn-default" type="button" data-action="num_purchased_stocks"><i class="fa fa-caret-up"></i></a> 
                    <button class="btn btn-default" type="button" data-action="num_purchased_stocks"><i class="fa fa-caret-down"></i></a> 
                  </div> 
                </div>
              </span> 
            </div> 
          </div>
        </div>
        <div class="row ">
          <div class="col-xs-6 col-md-4">
            <div class="purchase_price "> 
              <span>Amount to Pay</span> 
              <span>
                <div class="input-group spinner"> 
                  <input type="text" class="form-control" value="0" > 
                  <div class="input-group-btn-vertical"> 
                    <button class="btn btn-default" type="button" data-action="purchase_price"><i class="fa fa-caret-up"></i></a> 
                    <button class="btn btn-default" type="button" data-action="purchase_price"><i class="fa fa-caret-down"></i></a> 
                  </div> 
                </div>
              </span> 
            </div> 
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary">Purchase</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div class="modal fade" tabindex="-1" role="dialog" id="modal--income">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Enter company income</h4>
      </div>
      <div class="modal-body">
        <div class="row ">
          <div class="col-xs-6 col-md-4">
            <div class="rr_income "> 
              <span class="company_name"></span> 
          <span>
            <div class="input-group spinner"> 
              <input type="text" class="form-control" value="0" > 
              <div class="input-group-btn-vertical"> 
                <button class="btn btn-default" type="button" data-action="rr_income"><i class="fa fa-caret-up"></i></a> 
                <button class="btn btn-default" type="button" data-action="rr_income"><i class="fa fa-caret-down"></i></a> 
              </div> 
            </div>
          </span>
            </div> 
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary">Purchase</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Latest compiled and minified JavaScript -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

<script>

  var socket = io();
  var game_name = 'continental_divide';
  var game_oid;
  var user = localStorage.getItem("game-scoring--username"); 
  var companies = ['blue','red', 'yellow', 'pink', 'green', 'brown', 'purple', 'black'];

  var current_company = false;

  var connected_users = [];

  var nsp_socket;

$( document ).ready(function() {
  socket.emit('available_games', {name: game_name});

  $('#modal--username').modal({
    show:true
  });

  $('#modal--buyStock').modal({
    show:false
  });

  $('.modal-header button').on('click', function() {
    $(".modal-backdrop").remove();
  });

  if(user !== undefined && user !== null && user != ''){
    $("#username").val(user);
  } else {
    $('#modal--username').modal('toggle');
  }

  $(".company .btn").click(function(){
    $(".company .btn").removeClass('active');
    $(this).toggleClass('active');

    $(".purchaseCompanyStock").removeClass('hidden');

    socket.emit('get_company', { game_oid: game_oid, company_name: $(".company .btn.active").text().toLowerCase() });
  });

  $("#modal--username button").click(function(event){
    var _id = $('.available_games_dd .dropdown.selected a').data('oid');
    var numplayers = $('.num_players .dropdown.selected a').data('numplayers');

      if($("#username").val() == '' || _id === undefined || (_id == 'new' && numplayers === undefined)){
        alert_msg('modal-body', 'Please enter your username, game preference && number of players.');
      } else {
        localStorage.setItem("game-scoring--username", $("#username").val() );
        var action = (_id == 'new') ? 'add_game_instance' : 'join_game_instance';

        socket.emit('save username', $("#username").val());

        setUserRoom();
        
        socket.emit(action, 
          { game: { 
              name: game_name, 
              _id: $('.available_games_dd .dropdown.selected a').data('oid'),
              num_players: $('.num_players .dropdown.selected a').data('numplayers')
            },
            user: $("#username").val()
          }
        );
        $('#modal--username').modal('toggle');
      }  
  });

  $(".purchaseCompanyStock").click(function(){
    $('#modal--buyStock').modal('toggle');

    socket.emit('get_stock_values', {
      game_oid: game_oid,
      purchase: true
    });

    if(current_company.open) {
      $("#modal--buyStock .stock_value").addClass('hidden');
      $("#modal--buyStock .stocks_issued").addClass('hidden');
    } else {
      $("#modal--buyStock .stock_value").removeClass('hidden');
      $("#modal--buyStock .stocks_issued").removeClass('hidden');
    }

  });

  $("#modal--buyStock .modal-footer button").click(function(event){
    var action = (!current_company.open) ? 'init_company': '';
    update(action);
  });

  // $('.company_pane__fields .spinner .form-control').on('keyup', function(event) {
  //   var action = $(this).data('action');
  //   var spinner = $(this).parent().parent().find('input');

  //   if(event.keyCode == 38){
  //    updateValue(spinner, action, 'inc');
  //   }
  //   if(event.keyCode == 40){
  //     updateValue(spinner, action, 'dec');
  //   }
  // });

  $('.modal .spinner .btn:first-of-type').on('click', function() {
    var spinner = $(this).parent().parent().find('input');
    var action = $(this).data('action');
    updateValue(spinner, action, 'inc');
  });

  $('.modal .spinner .btn:last-of-type').on('click', function() {
    var spinner = $(this).parent().parent().find('input');
    var action = $(this).data('action');
    updateValue(spinner, action, 'dec');
  });

  $('.available_games_dd').on('click', function(e) {
    $('.available_games_dd .dropdown').removeClass('selected');
    
    if(e.originalEvent.target.id !== ''){
      $('#'+e.originalEvent.target.id).parent().addClass('selected');

      if(e.originalEvent.target.id == "new_instance"){
        $("#num_players").parent().removeClass('hidden');
      } else {
        $("#num_players").parent().addClass('hidden');
      }      
    }

  });

  // $('.num_purchased_stocks .spinner .btn:first-of-type').on('click', function() {
  //   var spinner = $(this).parent().parent().find('input');
  //   var val = parseInt($(spinner).val(), 10);
  //   var si =  parseInt($(".stocks_issued input").val(), 10);
  //   var initval = parseInt($(".stock_value input").data('initval'));

  //   if(initval != 0 && val < si ){
  //     $(spinner).val( val + 1);
  //   }
  // });

  // $('.num_purchased_stocks .spinner .btn:last-of-type').on('click', function() {
  //   var spinner = $(this).parent().parent().find('input');
  //   var val = parseInt($(spinner).val(), 10);
  //   if(val > 1){
  //     $(spinner).val( val - 1);
  //   }
  // });


  $('.num_players').on('click', function(e) {
    $('.num_players .dropdown').removeClass('selected');
    if(e.originalEvent.target.id !== ''){
      $('#'+e.originalEvent.target.id.toString() ).parent().addClass('selected');
    }
  });

});

  function alert_msg(klass, msg){
    $('.'+klass).prepend('<div class="alert alert-warning alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button> <strong>'+msg+'</div>');
    $('.'+klass+' .alert').fadeTo(2000, 500).slideUp(500, function(){
      $('.'+klass+' .alert').slideUp(500);
      $('.'+klass+' .alert').remove();
    });
  }

  function log_actions(msg){
    $('.log').append($('<li>').text(msg));
  }

  function updateValue(spinner, action, dir) {
    var val = parseInt($(spinner).val(), 10);

    switch (action) {
      case "stock_value":
        if(dir == 'inc'){
          if(val < 50){
            $(spinner).val( val + 1);
          }
        } else {
          if(val > 10){
            $(spinner).val( val - 1);
          }
        }
        break;
      case "stocks_issued":
        if(dir == 'inc'){
          if(val < 10){
            $(spinner).val( val + 1);
          }
        } else {
          if(val > 3){
            $(spinner).val( val - 1);
          }
        }
        break;
      case "num_purchased_stocks":
        if(dir == 'inc'){
          if(val < current_company.remaining_stock){
            val++;
            $(spinner).val( val );
          }
        } else {
          if(val > 1){
            val--;
            $(spinner).val( val );
          }
        }
        $('.purchase_price input').val( current_company.stock_price * val );
        break;
      case "purchase_price":
        var num_purchased_stocks = $('.num_purchased_stocks input').val();
        if(dir == 'inc'){
          $(spinner).val( val + 1);
        } else {
          var price = current_company.open ? current_company.stock_price * num_purchased_stocks : 10;
          if(val > price){
            $(spinner).val( val - 1);
          }
        }
        break;
      default:
        break;
    }

  }    


  function populateCompany(company){
    $(".company_name").text(company.name);
    
    $("#rr_income__txt").text(company.rr_income);  

    $("#stocks_issued__txt").text(company.stocks_issued);
    $("#stock_value__txt").text(company.stock_value);

    $("#stock_price__txt").text(company.stock_price);
    $("#dividend__txt").text(company.dividend);
    $("#dividend_payment__txt").text(company.remaining_stock * company.stock_price);
    $("#remaining_stock__txt").text(company.remaining_stock);

    current_company = company;

    // if(company.open === false){
    //   $(".purchaseCompanyStock").removeClass("hidden");
    // } else {
    //   $(".purchaseCompanyStock").addClass("hidden");
    // }
  }

  function update(action){
    var company = { tag: $(".company .btn.active").text().toLowerCase() };

    if(action == 'init_company'){
      company.stocks_issued = parseInt($(".stocks_issued input").val());
      company.stock_value = parseInt($(".stock_value input").val());
      company.remaining_stock = parseInt($(".stocks_issued input").val());
    }

    socket.emit('update_company', {
      game_oid: game_oid,
      action: action,
      company: company,
      user: user,
      num_purchased_stocks: parseInt($(".num_purchased_stocks input").val()),
      purchase_price: parseInt($(".purchase_price input").val())
    });
  }

  function calcDividend(stocks_issued, rr_income){
    var si = parseInt(stocks_issued);
    var ri = parseInt(rr_income);

    return isNaN( parseFloat(ri/si) ) ? 0 : Math.ceil( parseFloat(ri/si) );
  }

/******** Socket IO commands *****/

  socket.on('available_games', function(games){    
    var html = '<li role="presentation" class="dropdown"><a href="#" class="dropdown-toggle" id="new_instance" data-toggle="dropdown" data-oid="new" role="button" aria-haspopup="true" aria-expanded="false">+ Add New Instance</a></li>';
    for(var x=0,len=games.length;x<len;x++){
      html += '<li role="presentation" class="dropdown"><a href="#" class="dropdown-toggle" id="'+games[x]._id+'" data-oid="'+games[x]._id+'" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">'+games[x]._id+'</a></li>';
    }
    $('.dropdown-menu[aria-labelledby="available_games_dd"]').html(html);
  });

  socket.on('joined_game', function(msg){
console.log(msg);
    game_oid = msg._id;
    log_actions(msg.newest_user+' has joined the game');
  });

  socket.on('get_company', function(company){
    log_actions('information about '+company.name+' requested');
    
    if($('.company .btn.active') && company.tag == $('.company .btn.active').text().toLowerCase() ){
      $(".company_pane__fields").removeClass("hidden");
      populateCompany(company);
    } 
  });

  socket.on('update_company', function(company){
    var active_company = $(".company .btn.active").text().toLowerCase();

    if(active_company == company.tag){
      populateCompany(company);
    }
  });

  socket.on('get_stock_values', function(obj){
    var cv = obj.companies;

    var company = $('.company .btn.active').text().toLowerCase();

    var prv_sv = [], min_sv = 10;
    if(obj.purchase){
      if(cv[ company ].open){
        $(".purchase_price input").val( cv[ company ].stock_price );

        $(".num_purchased_stocks").removeClass("hidden");

        $("#modal--buyStock .stock_value").addClass("hidden");
        $("#modal--buyStock .stocks_issued").addClass("hidden");
      } else {
        for(var x=0,len=companies.length;x<len;x++){
          if(cv[ companies[x] ].open && !inArray(cv[ companies[x] ].stock_value, prv_sv)){
            prv_sv.push(cv[ companies[x] ].stock_value);
          }
        }
        prv_sv.sort(sortNumber);
        for(var x=0,len=prv_sv.length;x<len;x++){
          if(prv_sv[x] == min_sv){
            min_sv++;
          }
        }
        $("#modal--buyStock .stock_value").removeClass("hidden");
        $("#modal--buyStock .stocks_issued").removeClass("hidden");

        $(".stock_value input").val(min_sv);
        $(".stocks_issued input").val(3);

        $(".num_purchased_stocks").addClass("hidden");
        $(".purchase_price input").val(min_sv);
      }

    } 

  });

  function setUserRoom(){
    nsp_socket = io('/'+$("#username").val() );

    nsp_socket.on('close_purchase_window', function(company){
      $('#modal--buyStock').modal('toggle');
    });
  }

function inArray(needle, haystack) {
    var length = haystack.length;
    for(var i = 0; i < length; i++) {
        if(haystack[i] == needle) return true;
    }
    return false;
}

function sortNumber(a,b) {
    return a - b;
}

</script>
</body>
</html>