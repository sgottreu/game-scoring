function alert_msg(klass,msg){$("."+klass).prepend('<div class="alert alert-warning alert-dismissible fade in" role="alert"> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">Ã—</span></button> <strong>'+msg+"</div>"),$("."+klass+" .alert").fadeTo(2e3,500).slideUp(500,function(){$("."+klass+" .alert").slideUp(500),$("."+klass+" .alert").remove()})}function log_actions(msg){$(".log").append($("<li>").text(msg))}function updateValue(spinner,action,dir){var val=parseInt($(spinner).val(),10);switch(action){case"stock_value":var old_val=val;"inc"==dir?val<50&&(val++,$(spinner).val(val)):val>10&&(val--,$(spinner).val(val)),old_val!=val&&$(".purchase_price input").val(val);break;case"stocks_issued":"inc"==dir?val<10&&$(spinner).val(val+1):val>3&&$(spinner).val(val-1);break;case"num_purchased_stocks":"inc"==dir?val<current_company.remaining_stock&&(val++,$(spinner).val(val)):val>1&&(val--,$(spinner).val(val)),$(".purchase_price input").val(current_company.stock_price*val);break;case"purchase_price":var num_purchased_stocks=$(".num_purchased_stocks input").val();if("inc"==dir)$(spinner).val(val+1);else{var price=current_company.open?current_company.stock_price*num_purchased_stocks:10;val>price&&$(spinner).val(val-1)}break;case"rr_income":current_company.rr_income;if("inc"==dir)$(spinner).val(val+1);else{var price=current_company.rr_income;val>price&&$(spinner).val(val-1)}}$(".purchase_price input").val()>user_treasury&&alert_msg("modal-body","You do not have enough money to purchase that amount of stock.")}function populateCompany(company){$(".company_name").text(company.name),$("#rr_treasury__txt").text(company.rr_treasury),$("#rr_income__txt").text(company.rr_income),$("#stocks_issued__txt").text(company.stocks_issued),$("#stock_value__txt").text(company.stock_value),$("#stock_price__txt").text(company.stock_price),$("#dividend__txt").text(company.dividend),$("#dividend_payment__txt").text(company.remaining_stock*company.dividend),$("#remaining_stock__txt").text(company.remaining_stock),current_company=company}function update(action){var company={tag:$(".company .btn.active").text().toLowerCase()};"init_company"==action&&(company.stocks_issued=parseInt($(".stocks_issued input").val()),company.stock_value=parseInt($(".stock_value input").val()),company.remaining_stock=parseInt($(".stocks_issued input").val())),socket.emit("update_company",{game_oid:game_oid,action:action,company:company,user:user,num_purchased_stocks:parseInt($(".num_purchased_stocks input").val()),purchase_price:parseInt($(".purchase_price input").val())})}function calcDividend(stocks_issued,rr_income){var si=parseInt(stocks_issued),ri=parseInt(rr_income);return isNaN(parseFloat(ri/si))?0:Math.ceil(parseFloat(ri/si))}function setUserRoom(){nsp_socket=io("/"+$("#username").val()),nsp_socket.on("close_purchase_window",function(company){$("#modal--buyStock").modal("toggle")}),nsp_socket.on("close_income_window",function(company){$("#modal--income").modal("toggle")})}function inArray(needle,haystack){for(var length=haystack.length,i=0;i<length;i++)if(haystack[i]==needle)return!0;return!1}function sortNumber(a,b){return a-b}var socket=io(),game_name="continental_divide",game_oid,user=localStorage.getItem("game-scoring--username"),user_treasury=0,companies=["blue","red","yellow","pink","green","brown","purple","black"],current_company=!1,connected_users=[],nsp_socket;$(document).ready(function(){socket.emit("available_games",{name:game_name}),$("#modal--username").modal({show:!0}),$("#modal--buyStock").modal({show:!1}),$(".modal-header button").on("click",function(){$(".modal-backdrop").remove()}),void 0!==user&&null!==user&&""!=user?$("#username").val(user):$("#modal--username").modal("toggle"),$(".company .btn").click(function(){$(".company .btn").removeClass("active"),$(this).toggleClass("active"),$(".purchaseCompanyStock").removeClass("hidden"),$(".increaseCompanyIncome").removeClass("hidden"),socket.emit("get_company",{game_oid:game_oid,company_name:$(".company .btn.active").text().toLowerCase()})}),$("#modal--username button").click(function(event){var _id=$(".available_games_dd .dropdown.selected a").data("oid"),numplayers=$(".num_players .dropdown.selected a").data("numplayers");if(""==$("#username").val()||void 0===_id||"new"==_id&&void 0===numplayers)alert_msg("modal-body","Please enter your username, game preference && number of players.");else{localStorage.setItem("game-scoring--username",$("#username").val());var action="new"==_id?"add_game_instance":"join_game_instance";socket.emit("save username",$("#username").val()),setUserRoom(),socket.emit(action,{game:{name:game_name,_id:$(".available_games_dd .dropdown.selected a").data("oid"),num_players:$(".num_players .dropdown.selected a").data("numplayers")},user:$("#username").val()}),$("#modal--username").modal("toggle")}}),$(".purchaseCompanyStock").click(function(){$("#modal--buyStock").modal("toggle"),socket.emit("get_stock_values",{game_oid:game_oid,purchase:!0,user:user}),current_company.open?($("#modal--buyStock .stock_value").addClass("hidden"),$("#modal--buyStock .stocks_issued").addClass("hidden")):($("#modal--buyStock .stock_value").removeClass("hidden"),$("#modal--buyStock .stocks_issued").removeClass("hidden"))}),$("#modal--buyStock .modal-footer button").click(function(event){if($(".purchase_price input").val()>user_treasury)alert_msg("modal-body","You do not have enough money to purchase that amount of stock.");else{var action=current_company.open?"":"init_company";update(action)}}),$(".increaseCompanyIncome").click(function(){$("#rr_income").val(current_company.rr_income),$("#modal--income").modal("toggle")}),$("#modal--income .modal-footer button").click(function(event){current_company.rr_income=parseInt($("#rr_income").val(),10),socket.emit("modify_railroad_income",{game_oid:game_oid,user:user,company:current_company})}),$(".modal .spinner .btn:first-of-type").on("click",function(){var spinner=$(this).parent().parent().find("input"),action=$(this).data("action");updateValue(spinner,action,"inc")}),$(".modal .spinner .btn:last-of-type").on("click",function(){var spinner=$(this).parent().parent().find("input"),action=$(this).data("action");updateValue(spinner,action,"dec")}),$(".available_games_dd").on("click",function(e){$(".available_games_dd .dropdown").removeClass("selected"),""!==e.originalEvent.target.id&&($("#"+e.originalEvent.target.id).parent().addClass("selected"),"new_instance"==e.originalEvent.target.id?$("#num_players").parent().removeClass("hidden"):$("#num_players").parent().addClass("hidden"))}),$(".num_players").on("click",function(e){$(".num_players .dropdown").removeClass("selected"),""!==e.originalEvent.target.id&&$("#"+e.originalEvent.target.id.toString()).parent().addClass("selected")})}),socket.on("available_games",function(games){for(var html='<li role="presentation" class="dropdown"><a href="#" class="dropdown-toggle" id="new_instance" data-toggle="dropdown" data-oid="new" role="button" aria-haspopup="true" aria-expanded="false">+ Add New Instance</a></li>',x=0,len=games.length;x<len;x++)html+='<li role="presentation" class="dropdown"><a href="#" class="dropdown-toggle" id="'+games[x]._id+'" data-oid="'+games[x]._id+'" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">'+games[x]._id+"</a></li>";$('.dropdown-menu[aria-labelledby="available_games_dd"]').html(html)}),socket.on("joined_game",function(msg){game_oid=msg._id,user_treasury=msg.users[msg.newest_user].cash_total,log_actions(msg.newest_user+" has joined the game")}),socket.on("get_company",function(company){log_actions("information about "+company.name+" requested"),$(".company .btn.active")&&company.tag==$(".company .btn.active").text().toLowerCase()&&($(".company_pane__fields").removeClass("hidden"),populateCompany(company))}),socket.on("update_company",function(company){var active_company=$(".company .btn.active").text().toLowerCase();active_company==company.tag&&populateCompany(company)}),socket.on("get_stock_values",function(obj){var cv=obj.companies;user_treasury=obj.user_treasury;var company=$(".company .btn.active").text().toLowerCase(),prv_sv=[],min_sv=10;if(obj.purchase)if(cv[company].open)$(".purchase_price input").val(cv[company].stock_price),$(".num_purchased_stocks").removeClass("hidden"),$("#modal--buyStock .stock_value").addClass("hidden"),$("#modal--buyStock .stocks_issued").addClass("hidden");else{for(var x=0,len=companies.length;x<len;x++)cv[companies[x]].open&&!inArray(cv[companies[x]].stock_value,prv_sv)&&prv_sv.push(cv[companies[x]].stock_value);prv_sv.sort(sortNumber);for(var x=0,len=prv_sv.length;x<len;x++)prv_sv[x]==min_sv&&min_sv++;$("#modal--buyStock .stock_value").removeClass("hidden"),$("#modal--buyStock .stocks_issued").removeClass("hidden"),$(".stock_value input").val(min_sv),$(".stocks_issued input").val(3),$(".num_purchased_stocks").addClass("hidden"),$(".purchase_price input").val(min_sv)}});